<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<dom-module id="dash-issues">
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
      }

      table {
        border-collapse: collapse;
        font-size: 0.8em;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                  0 1px 5px 0 rgba(0, 0, 0, 0.12),
                  0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      td {
        padding: 1em;
      }

      th {
        padding: 0;
        background-color: #fff;
      }

      tr:nth-child(even) {
        background-color: #ddd;
      }

      button {
        border: none;
        background-color: inherit;
        font-weight: bolder;
        font-size: inherit;
        font-family: inherit;
        padding: 1.5em 1em;
      }

      button:hover {
        cursor: pointer;
      }

      .open-status {
        text-transform: capitalize;
      }

      .up, .down {
        background-color: var(--app-selected-color);
      }

      .up::after {
        content: "▲";
        font-size: 0.75em;
      }

      .down::after {
        content: "▼";
        font-size: 0.75em;
      }


      @media (max-width: 640) {
        td, th {
          padding: 0.5em;
        }
      }
    </style>
    <paper-dropdown-menu label="Filter" value="{{filterValue}}">
      <paper-listbox class="dropdown-content">
        <paper-item role="option">None</paper-item>
        <paper-item role="option">Open</paper-item>
        <paper-item role="option">Closed</paper-item>
      </paper-listbox>
    </paper-dropdown-menu>
    <table>
      <tr>
        <th><button on-tap="_updateSort" value="opened_timestamp">Opened</button></th>
        <th><button on-tap="_updateSort" value="customer_name">Customer</button></th>
        <th><button on-tap="_updateSort" value="email">Email</button></th>
        <th><button on-tap="_updateSort" value="description">Description</button></th>
        <th><button on-tap="_updateSort" value="open">Open</button></th>
        <th><button on-tap="_updateSort" value="closed_timestamp">Closed</button></th>
        <th><button on-tap="_updateSort" value="employee_name">Employee</button></th>
      </tr>
      <template is="dom-repeat" items="[[issues]]" sort="[[sort]]" filter="[[filter]]">
        <tr>
          <td>[[_computeDate(item.opened_timestamp)]]</td>
          <td>[[item.customer_name]]</td>
          <td>[[item.email]]</td>
          <td>[[item.description]]</td>
          <td class="open-status">[[item.open]]</td>
          <td>[[_computeDate(item.closed_timestamp)]]</td>
          <td>[[item.employee_name]]</td>
        </tr>
      </template>
    </table>
  </template>

  <script>
    Polymer({

      is: 'dash-issues',

      properties: {
        issues: {
          type: Array,
          value: [],
          notify: true
        },
        sort: {
          type: Function,
          notify: true
        },
        ascending: {
          type: Boolean,
          value: true,
          notify: true
        },
        filter: {
          type: Function,
          notify: true
        },
        arrow: {
          type: String,
          notify: true
        }
      },

      observers: ['_updateFilter(filterValue)'],

      _computeDate: function(date) {
        if (date) {
          var time = new Date(date);
          return time.toDateString();
        }
        else {
          return '';
        }
      },

      ready: function() {
        this.sort = function(a, b) {
          if (a['opened_timestamp'] < b['opened_timestamp']) {
            return -1;
          }
          else if (a['opened_timestamp'] > b['opened_timestamp']) {
            return 1;
          }
          return 0;
        };
        this.ascending = false;
        this.arrow = 'up';
        this.$$('button').className = 'up';
      },

      _updateSort: function(e) {
        var target = e.path[0];
        var buttons = Polymer.dom(this.root).querySelectorAll('button');
        buttons.forEach(function(button) {
          button.className = '';
        });
        var prop = e.path[0].value;
        if (this.ascending) {
          this.sort = this.setSort(1, prop);
          this.ascending = false;
          this.arrow = 'up';
          target.className = 'up';
        }
        else {
          this.sort = this.setSort(-1, prop);
          this.ascending = true;
          this.arrow = 'down';
          target.className = 'down';
        }
      },

      setSort: function(val, property) {
        return function(a, b) {
          if (a[property] < b[property]) {
            return -val;
          }
          else if (a[property] > b[property]) {
            return val;
          }
          return 0;
        }
      },

      _updateFilter: function(val) {
        switch (val) {
          case 'Open':
            this.filter = this.setFilter('open', true);
            break;
          case 'Closed':
            this.filter = this.setFilter('open', false);
            break
          default:
            this.filter = function(item) {return item;};
            break;
        }
      },

      setFilter: function(property, value) {
        return function(item) {
          return item[property] === value;
        }
      }

    });
  </script>
</dom-module>
